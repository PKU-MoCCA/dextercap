import numpy as np
import rerun as rr
import smplx
import torch

import HandReconstruction.config as config
from HandReconstruction.Utility.utils_mesh import (
    compute_vertex_normals,
    extract_submesh,
)

vertice_patch_0 = [
    20,
    21,
    18,
    19,
    16,
    17,
    22,
    23,
    217,
    219,
    216,
    218,
    208,
    207,
    204,
    178,
    181,
    180,
    179,
    203,
    80,
    184,
    200,
    55,
    83,
    182,
    183,
    220,
    143,
    206,
    144,
    145,
    158,
    227,
    84,
    205,
    209,
    192,
    193,
    229,
    211,
    210,
    191,
    190,
]
vertice_patch_1 = [
    139,
    137,
    133,
    134,
    189,
    195,
    194,
    165,
    164,
    174,
    175,
    212,
    136,
    177,
    176,
    261,
    135,
    173,
    140,
    170,
    171,
    274,
    263,
    138,
    168,
    169,
    172,
    258,
    260,
    186,
]
vertice_patch_2 = [
    221,
    299,
    282,
    294,
    224,
    300,
    283,
    295,
    281,
    301,
    344,
    238,
    341,
    342,
    272,
    296,
    237,
    340,
    330,
    273,
    297,
    245,
    298,
    331,
    222,
    226,
    86,
    223,
    56,
    280,
    57,
    47,
    155,
    46,
    166,
    48,
    49,
    156,
    58,
    167,
    225,
    213,
    87,
    59,
    133,
    212,
    175,
    134,
    174,
    164,
    165,
    194,
    195,
    189,
]
vertice_patch_3 = [
    352,
    316,
    303,
    313,
    339,
    350,
    315,
    334,
    312,
    335,
    314,
    319,
    337,
    336,
    311,
    310,
    346,
    348,
    351,
    318,
    308,
    354,
    349,
    353,
    347,
    317,
    355,
    307,
    306,
    324,
    350,
    327,
    332,
    309,
    343,
    329,
    305,
    326,
    323,
    304,
    328,
    325,
    322,
    321,
    302,
    345,
    320,
    333,
    338,
    294,
    295,
    296,
    297,
    299,
    300,
    344,
    342,
    330,
    331,
]
vertice_patch_4 = [
    370,
    380,
    378,
    379,
    363,
    365,
    362,
    389,
    373,
    394,
    359,
    377,
    376,
    358,
    366,
    367,
    385,
    388,
    387,
    382,
    386,
    381,
    374,
    375,
    383,
    399,
    384,
    369,
    371,
    368,
    185,
    187,
    270,
    269,
    262,
    228,
    288,
    246,
    277,
    75,
]
vertice_patch_5 = [
    410,
    409,
    452,
    453,
    412,
    413,
    453,
    408,
    411,
    406,
    397,
    407,
    396,
    398,
    403,
    401,
    393,
    400,
    390,
    404,
    405,
    392,
    402,
    391,
    357,
    356,
    372,
    395,
    361,
    360,
    364,
    362,
    359,
    373,
    358,
    376,
    377,
    363,
    365,
    389,
    394,
]
vertice_patch_6 = [
    456,
    454,
    440,
    429,
    431,
    441,
    430,
    415,
    457,
    414,
    445,
    428,
    451,
    450,
    464,
    426,
    419,
    463,
    437,
    416,
    433,
    425,
    467,
    442,
    447,
    466,
    436,
    449,
    460,
    439,
    418,
    462,
    423,
    417,
    461,
    432,
    435,
    424,
    438,
    446,
    421,
    448,
    455,
    459,
    420,
    458,
    427,
    422,
    434,
    443,
    444,
    465,
    409,
    410,
    408,
    452,
    453,
    407,
    412,
    413,
    411,
    406,
]
vertice_patch_7 = [
    606,
    599,
    586,
    583,
    582,
    602,
    587,
    613,
    615,
    603,
    614,
    591,
    622,
    589,
    601,
    617,
    590,
    600,
    609,
    616,
    610,
    611,
    627,
    612,
    597,
    596,
    593,
    607,
    592,
    608,
    696,
    594,
    595,
    604,
    605,
    199,
    161,
    289,
    202,
    201,
]
vertice_patch_8 = [
    685,
    669,
    684,
    668,
    682,
    639,
    640,
    634,
    641,
    680,
    681,
    636,
    637,
    638,
    635,
    631,
    625,
    621,
    624,
    618,
    626,
    629,
    632,
    628,
    633,
    588,
    584,
    585,
    623,
    598,
    619,
    580,
    620,
    630,
    581,
    622,
    603,
    602,
    582,
    583,
    599,
    586,
    587,
    589,
    617,
]
vertice_patch_9 = [
    675,
    659,
    642,
    658,
    673,
    657,
    656,
    679,
    654,
    647,
    661,
    653,
    694,
    695,
    670,
    644,
    664,
    677,
    688,
    655,
    666,
    687,
    650,
    683,
    648,
    643,
    649,
    651,
    666,
    652,
    674,
    676,
    686,
    689,
    678,
    690,
    646,
    645,
    667,
    660,
    663,
    671,
    672,
    662,
    665,
    693,
    691,
    692,
    634,
    635,
    636,
    637,
    668,
    669,
    682,
    684,
    685,
    639,
]
vertice_patch_10 = [
    488,
    489,
    579,
    510,
    495,
    504,
    499,
    474,
    477,
    475,
    483,
    487,
    486,
    471,
    479,
    491,
    492,
    484,
    497,
    485,
    498,
    496,
    478,
    509,
    493,
    481,
    480,
    494,
    490,
    470,
    247,
    293,
    76,
    141,
    197,
    198,
    162,
    163,
    291,
    292,
]
vertice_patch_11 = [
    563,
    552,
    522,
    523,
    567,
    551,
    565,
    517,
    519,
    520,
    521,
    524,
    518,
    564,
    503,
    514,
    506,
    500,
    507,
    515,
    511,
    508,
    512,
    516,
    472,
    473,
    501,
    502,
    513,
    476,
    505,
    482,
    468,
    469,
    474,
    475,
    477,
    499,
    504,
    487,
    486,
    470,
    471,
    483,
]
vertice_patch_12 = [
    526,
    541,
    568,
    542,
    531,
    525,
    525,
    556,
    540,
    539,
    562,
    545,
    575,
    576,
    537,
    540,
    548,
    530,
    574,
    527,
    578,
    558,
    553,
    544,
    536,
    577,
    560,
    547,
    571,
    550,
    573,
    572,
    534,
    529,
    528,
    535,
    543,
    546,
    557,
    570,
    566,
    549,
    559,
    569,
    532,
    538,
    533,
    561,
    554,
    555,
    522,
    523,
    567,
    565,
    551,
    552,
    520,
    519,
    518,
    517,
]
vertice_patch_13 = [
    105,
    286,
    253,
    89,
    236,
    231,
    88,
    233,
    42,
    43,
    232,
    90,
    41,
    235,
    91,
    39,
    229,
    193,
    4,
    114,
    7,
    264,
    6,
    5,
    40,
    36,
    252,
    248,
    123,
    126,
    240,
    115,
    113,
    265,
    287,
    104,
    250,
    251,
]
vertice_patch_14 = [
    709,
    742,
    757,
    707,
    741,
    755,
    712,
    708,
    713,
    714,
    711,
    710,
    753,
    754,
    700,
    704,
    699,
    701,
    703,
    702,
    698,
    697,
    705,
    706,
    104,
    287,
    250,
    31,
    28,
    251,
    267,
    125,
    124,
    249,
    715,
    758,
]
vertice_patch_15 = [
    732,
    752,
    729,
    747,
    728,
    727,
    720,
    717,
    726,
    724,
    719,
    725,
    718,
    716,
    723,
    722,
    733,
    731,
    721,
    736,
    739,
    759,
    756,
    760,
    749,
    746,
    740,
    763,
    762,
    761,
    750,
    743,
    768,
    734,
    737,
    730,
    735,
    738,
    744,
    745,
    766,
    767,
    764,
    765,
    751,
    748,
]
vertice_patch_16 = [
    96,
    97,
    98,
    99,
    243,
    244,
    131,
    130,
    101,
    772,
    773,
    774,
    73,
    777,
    188,
    241,
    255,
    102,
    771,
    775,
    72,
    45,
    32,
    257,
    284,
    106,
    154,
]

vertice_of_patch = [
    vertice_patch_0,
    vertice_patch_1,
    vertice_patch_2,
    vertice_patch_3,
    vertice_patch_4,
    vertice_patch_5,
    vertice_patch_6,
    vertice_patch_7,
    vertice_patch_8,
    vertice_patch_9,
    vertice_patch_10,
    vertice_patch_11,
    vertice_patch_12,
    vertice_patch_13,
    vertice_patch_14,
    vertice_patch_15,
    vertice_patch_16,
]

if __name__ == "__main__":

    def check_common_elements(arr1, arr2):
        return any(elem in arr1 for elem in arr2)

    arrays = [
        vertice_patch_0,
        vertice_patch_1,
        vertice_patch_2,
        vertice_patch_3,
        vertice_patch_4,
        vertice_patch_5,
        vertice_patch_6,
        vertice_patch_7,
        vertice_patch_8,
        vertice_patch_9,
        vertice_patch_10,
        vertice_patch_11,
        vertice_patch_12,
        vertice_patch_13,
        vertice_patch_14,
        vertice_patch_15,
    ]

    for i in range(len(arrays)):
        for j in range(i + 1, len(arrays)):
            if check_common_elements(arrays[i], arrays[j]):
                print(
                    f"Arrays vertice_patch_{i} and vertice_patch_{j} have common elements, the common elements are:"
                )
                common_elements = [elem for elem in arrays[i] if elem in arrays[j]]
                print(common_elements)

    smplx_model = smplx.create(
        model_path=config.data["smpl_model_path"],
        model_type="mano",
        flat_hand_mean=True,
        is_rhand=False,
        use_pca=False,
        batch_size=1,
    )

    hand_parms = {
        "global_orient": torch.zeros(1, 3),
        "transl": torch.zeros(1, 3),
        "hand_pose": torch.zeros(1, 45),
        "betas": torch.zeros(1, 10),
    }
    smplx_output = smplx_model(**hand_parms)

    vertices = smplx_output.vertices[0].detach().cpu().numpy()
    joints = smplx_output.joints[0].detach().cpu().numpy()

    # Record root position
    rr.init("MANO_segment", spawn=True)
    rr.log("", rr.ViewCoordinates.RIGHT_HAND_Y_UP, static=True)  # Set an up-axis = +Y
    rr.set_time("stable_time", duration=0)
    rr.log(
        "hand/mesh",
        rr.Mesh3D(
            vertex_positions=vertices,
            triangle_indices=smplx_model.faces,
            vertex_normals=compute_vertex_normals(vertices, smplx_model.faces),
        ),
    )

    colors = [
        [230, 97, 92],
        [88, 196, 157],
        [106, 137, 204],
        [255, 193, 84],
        [186, 123, 202],
        [95, 195, 228],
        [207, 106, 135],
        [139, 195, 74],
        [79, 134, 153],
        [255, 167, 38],
        [149, 117, 205],
        [38, 198, 218],
        [158, 158, 158],
        [121, 85, 72],
        [183, 28, 28],
        [56, 142, 60],
        [63, 81, 181],
    ]

    for i in range(vertices.shape[0]):
        vertex_color = [255, 255, 255]
        for patch_idx, patch_vertices in enumerate(vertice_of_patch):
            if i in patch_vertices:
                vertex_color = colors[patch_idx]
                break

        rr.log(
            f"hand/vertex/vertex_{i}",
            rr.Points3D(
                positions=vertices[i],
                radii=0.001,
                colors=np.full(vertices[i].shape, vertex_color, dtype=np.uint8),
                labels=[f"{i}"],
            ),
        )
    for i in range(joints.shape[0]):
        rr.log(
            f"hand/joint/joint_{i}",
            rr.Points3D(
                positions=joints[i],
                radii=0.001,
                colors=np.full(joints[i].shape, [0, 255, 0], dtype=np.uint8),
                labels=[f"joint_{i}"],
            ),
        )

    # Visualize submeshes for each patch segment

    for i, patch_vertices in enumerate(vertice_of_patch):
        if len(patch_vertices) == 0:
            continue

        submesh_vertices, submesh_faces = extract_submesh(
            vertices, smplx_model.faces, patch_vertices
        )

        rr.log(
            f"hand/submesh_{i}",
            rr.Mesh3D(
                vertex_positions=submesh_vertices,
                triangle_indices=submesh_faces,
                vertex_normals=compute_vertex_normals(submesh_vertices, submesh_faces),
                vertex_colors=np.full(
                    (len(submesh_vertices), 3), colors[i], dtype=np.uint8
                ),
            ),
        )
